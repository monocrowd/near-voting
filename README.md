# near-voting
An Voting app in Near



# TLDR Tutorial
## Setup
1. Install prerequisites
   - NodeJS: https://nodejs.org/en/
   - Rust: https://www.rust-lang.org/
   - Near-cli: https://docs.near.org/docs/tools/near-cli#installation

2. Create project
   - `npx create-near-app - frontend=react - contract=rust near-voting`
  

## Contract
1. Remove `Welcome` contract generated by create-near-app in `contract/src/lib.rs`
2. Define `Candidate` to store the information about the candidate
   ```rust
   type CandidateId = String;

   #[derive(BorshDeserialize, BorshSerialize, Serialize, Deserialize)]
   #[serde(crate = "near_sdk::serde")]
   pub struct Candidate {
      candidate_id: CandidateId,
      metadata: Option<HashMap<String, String>>,
      votes: u128,
   }   
   ```

3. Define the voting contract struct in `contract/src/lib/rs`
   ```rust
   #[near_bindgen]
   #[derive(BorshDeserialize, BorshSerialize)]
   pub struct VotingContract {
      candidates: UnorderedMap<CandidateId, Candidate>,
      votes: LookupMap<AccountId, CandidateId>,
   }
   ```
   Key Points
   - https://www.near-sdk.io/contract-structure/collections

4. Implement `Default` for the contract struct
   ```rust
   impl Default for VotingContract {
      fn default() -> Self {
         Self {
            candidates: UnorderedMap::new(b"c".to_vec()),
            votes: LookupMap::new(b"v".to_vec()),
         }
      }
   }
   ```

5. Implement voting contract APIs
   ```rust
   #[near_bindgen]
   impl VotingContract {
      pub fn add_candidate(
         &mut self,
         candidate_id: CandidateId,
         metadata: Option<HashMap<String, String>>,
      ) {
         if self.candidates.get(&candidate_id).is_some() {
               env::panic(format!("candidate {} already exists", candidate_id).as_bytes());
         }
         let candidate = Candidate {
               candidate_id: candidate_id.clone(),
               metadata,
               votes: 0,
         };
         self.candidates.insert(&candidate_id, &candidate);
      }

      pub fn view_candidates(&self) -> Vec<Candidate> {
         self.candidates.values().collect()
      }

      pub fn vote(&mut self, candidate_id: CandidateId) {
         let voter = env::predecessor_account_id();
         if self.votes.get(&voter).is_some() {
               env::panic("you can only vote once".as_bytes());
         }
         match self.candidates.get(&candidate_id) {
               Some(mut candidate) => {
                  candidate.votes += 1;
                  self.candidates.insert(&candidate_id, &candidate);
                  self.votes.insert(&voter, &candidate_id);
               }
               None => env::panic(format!("candidate {} not exists", candidate_id).as_bytes()),
         }
      }
   }
   ```
   Key Points
   - https://docs.rs/near-sdk/3.1.0/near_sdk/env/fn.predecessor_account_id.html
6. Build the contract
   - under project root directory run `npm run build:contract`
7. Deploy the contract to dev account
   - under project root directory run `npm run dev:deploy:contract`, you will see following
      ```shell
      Starting deployment. Account id: dev-1637854255573-70088621941957, node: https://rpc.testnet.near.org, helper: https://helper.testnet.near.org, file: ./out/main.wasm
      Transaction Id 2XZiV2WP36zrawvSDZoUnBqthHFp3K4qZPZa4vhX747e
      To see the transaction in the transaction explorer, please open this url in your browser
      https://explorer.testnet.near.org/transactions/2XZiV2WP36zrawvSDZoUnBqthHFp3K4qZPZa4vhX747e
      Done deploying to dev-1637854255573-70088621941957      
      ```
8. Test contract
   - set CONTRACT_NAME environment to the dev account generated in previous step
      - `export CONTRACT_NAME=dev-1637854255573-70088621941957`
   - test APIs
      1. view_candidates
         - near view $CONTRACT_NAME view_candidates --accountId $CONTRACT_NAME
      2. add_candidate
         - near call $CONTRACT_NAME add_candidate '{"candidate_id": "Tom"}' --accountId $CONTRACT_NAME
      3. vote
         - near call $CONTRACT_NAME vote '{"candidate_id": "Tom"}' --accountId $VOTER_ACCOUNT_ID
9. Deploy to your account once test completed
   - config network and login
      - `export NODE_ENV=testnet`
      - `near login`
   - `near deploy --wasmFile contract/target/wasm32-unknown-unknown/release/near_voting.wasm --accountId YOUR_ACCOUNT`